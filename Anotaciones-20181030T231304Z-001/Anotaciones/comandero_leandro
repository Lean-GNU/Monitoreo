--------------------------------------------------------------------------------
			TCPDUMP

tcpdump [-aAdDeflLnNOpqRStuUvxX] [-c count] [ -C file_size ]
           [ -E algo:secret ] [ -F file ] [ -i interface ] [ -M secret ]
           [ -r file ] [ -s snaplen ] [ -T type ] [ -w file ]
           [ -W filecount ] [ -y datalinktype ] [ -Z user ]
           [ expression ]
-A: Imprime cada paquete en [[código ASCII]]
-D: Imprime la lista de interfaces disponibles 
-n: No convierte las direcciones de salida
-p: No utliza la [[interfaz]] especificada en [[modo promiscuo]]
-t: No imprime la hora de captura de cada [[Trama de red|trama]]
-x: Imprime cada paquete en [[hexadecimal]]
-X: Imprime cada paquete en [[hexadecimal]] y [[código ASCII]]

-c count: Cierra el [[Software|programa]] tras recibir 'count' paquetes
-C file_size
-E algo:secret
-F file
-i interface: Escucha en la interfaz especificada
-M secret
-r file
-s snaplen
-T type
-w file: Guarda la salida en el [[Archivo (informática)|archivo]] 'file'
-W filecount
-y datalinktype
-Z user

	Filtros

    type [host|net|port]: Máquina en particular [host], red completa [net] o puerto concreto [port].
    dir [src|dst|src or dst|src and dst]: Especifica desde [src] o hacia dónde [dst] se dirige la información.
    proto [tcp|udp|ip|ether]: Protocolo que queremos capturar.
Ejemplos:

* Capturar tráfico cuya dirección IP de origen sea 192.168.3.1

	#tcpdump src host 192.168.3.1

* Capturar tráfico cuya dirección origen o destino sea 192.168.3.2

	#tcpdump host 192.168.3.2

* Capturar tráfico con destino a la dirección MAC 50:43:A5:AE:69:55

	#tcpdump ether dst 50:43:A5:AE:69:55

* Capturar tráfico con red destino 192.168.3.0

	#tcpdump dst net 192.168.3.0

* Capturar tráfico con red origen 192.168.3.0/28

	#tcpdump src net 192.168.3.0 mask 255.255.255.240
	#tcpdump src net 192.168.3.0/28

* Capturar tráfico con destino el puerto 23

	#tcpdump dst port 23

* Capturar tráfico con origen o destino el puerto 110

	#tcpdump port 110

* Capturar los paquetes de tipo ICMP

	#tcpdump ip proto \\icmp

* Capturar los paquetes de tipo UDP

	#tcpdump ip proto \\udp
	#tcpdump udp

* Capturar el tráfico Web

	#tcpdump tcp and port 80

* Capturar las peticiones de DNS

	#tcpdump udp and dst port 53

* Capturar el tráfico al puerto telnet o SSH

	#tcpdump tcp and \(port 22 or port 23\)

* Capturar todo el tráfico excepto el web

	#tcpdump tcp and not port 80

otra forma:

	#tcpdump tcp and ! port 80

	#tcpdump -vvv -n -s 65535 -A -p -w /tmp/tcpdump host 10.168.1.100 and port 80

--------------------------------------------------------------------------------------
				DMESG

La forma más simple de usar dmesg es escribir:

		#dmesg

Pero la cantidad de mensajes generada puede resultarnos excesiva. Existen varias formas de filtrar la información.
Podemos usar dos opciones de dmesg llamadas facility y level. Vamos a verlo con un ejemplo: Queremos que aparezcan solamente los mensajes de error y de advertencia (warning). Para ello usaremos la opción level. Escribiremos:

		#dmesg --level=err,warn

o bien:

		#dmesg -l err,warn

Para saber que a que información podemos acceder con facility y level podemos consultar la ayuda de dmesg con la opción help:

		#dmesg --help

Otra forma de filtrar los mensajes es usando el comando grep. Por ejemplo, queremos obtener solamente los mensajes relativos a dispositivos usb. Escribiremos:

		#dmesg | grep -i usb

Lo  que hará está línea será, primero ejecutar dmesg,  luego pasará el resultado al comando grep, que buscará todos los mensajes en los que aparezca usb y los mostrará en la pantalla.
También puede resultanos interesante acceder solamente a los últimos mensajes generados. Para ello escribiremos:

		#dmesg | tail

Finalmente si queremos obtener un archivo de texto con la información generada por dmesg podemos escribir:

		#dmesg > mensajes_del_kernel
---------------------------------------------------------------------------------------------------------------------
				IOTOP

"iotop" sirve para ver los detalles de acceso a disco de un proceso y poder ver la cantidad de informacion que lee y escribe en un momento dado.

--------------------------------------------------------------------------------------------------------------------
					APT-GET

Comandos "apt-get":

1. Actualizar el listado de paquetes disponibles:

sudo apt-get update


2. Comprobar que todo ha ido bien tras la utilización de apt-get update:

sudo apt-get check


3. Instalar los programas deseados:

sudo apt-get install paquete


4. Reinstalar un programa:

sudo apt-get -reinstall install paquete


5. Actualizar solo los paquetes ya instalados que no necesitan, como dependencia, la instalación o desinstalación de otros paquetes:

sudo apt-get upgrade


6. Actualizar todos los paquetes del sistema, instalando o desinstalando los paquetes que sean necesarios para resolver las dependencias que pueda generar la actualización de algún paquete:

sudo apt-get dist-upgrade


7. Desinstalar un paquete:

sudo apt-get remove paquete


8. Desinstalar un paquete y elimina los archivos de configuración:

sudo apt-get remove --purge paquete


9. Resolver problemas con dependencias y paquetes rotos:

sudo apt-get -f install

Puede ser necesario reconfigurar dpkg con:

sudo sudo dpkg --configure -a


10. Para limpiar los paquetes descargados e instalados:

sudo apt-get clean


11. Para limpiar los paquetes viejos que ya no se usan:

sudo apt-get autoclean


12. Para buscar un paquete determinado:

sudo apt-cache search paquete


13. Descargar archivos fuente:

sudo apt-get source paquete


14. Configurar las dependencias de construcción para paquetes fuente:

sudo apt-get build-dep paquete


15. Seguir las selecciones de dselect:

sudo apt-get dselect-upgrade


16. Para conocer que paquetes hay instalados:

sudo apt-show-versions (-u)


17. Obtener más información de un paquete específico:

sudo apt-cache show paquete


18. Más información aún:

sudo apt-cache showpkg paquete


19. Para saber de que paquete depende:

sudo apt-cache depends paquete


20. Para encontrar el nombre de un paquete desde un archivo:

sudo apt-file search archivo

21. Listar el contenido de un paquete:

sudo apt-file list paquete


22. Para mantener al día esta función:

sudo apt-file update


23. Para mantener el sistema limpio de bibliotecas inútiles:

sudo apt-get autoremove


24. Actualizar la caché de paquetes (/var/cache/apt/pkgcache.bin), crea un nuevo árbol de dependencias:

sudo apt-get check


25. Mostrar un resumen de las dependencias no satisfechas en la caché de paquetes:

sudo apt-cache unmet


26. Mostrar una lista de todo lo que tenemos instalado en el sistema:

sudo apt-cache pkgnames -generate

Opciones:

-s 	Simula una acción.
-d 	Sólo descarga.
-y 	No pregunta y asume que si a todo.
-u 	Muestra paquetes actualizados.
-h 	Muestra texto de ayuda.
-q 	Salida registrable - sin indicador de progreso.
-qq 	Sin salida, excepto si hay errores.
-f 	Intenta continuar sí la comprobación de integridad falla (dependencias rotas).
-m 	Intenta continuar si los archivos no son localizables.
-b 	Construye el paquete fuente después de obtenerlo.
-V 	Muesta números de versión detallados.
-c=? 	Lee este archivo de configuración.
-o=? 	Establece una opción de configuración arbitraria.

----------------------------------------------------------------------------------------------------$

tail -f [ruta] Muestra el archivo a medida que se va creando.

----------------------------------------------------------------------------------------------------$

cat /proc/interrupts para ver las interrupciones de hardware
cat /proc/interrupts | grep eth ver interrupciones en placas ethernet

----------------------------------------------------------------------------------------------------$

#/opt/sequreisp/deploy: ver lo que esta ocurriendo en sequreisp
#sequreisp -t production: diagnosticar sequreisp
#/opt/sequreisp/deploy/current/log: logs de sequreisp
#sequreisp -c:
#sequreisp -a:

----------------------------------------------------------------------------------------------------$
                                Comandos tc

tc qdisc del dev ifb0 root      //Quitan reglas de las interfaces virtuales para realizar pruebas
tc qdisc del dev ifb1 root

----------------------------------------------------------------------------------------------------$
                                Comandos satura

/usr/local/bin/satura: aca se encuentra el script de satura (links de descargas)
#satura [interfaz]: satura una interfaz

----------------------------------------------------------------------------------------------------$
                                pioja
192.168.20.45

----------------------------------------------------------------------------------------------------$
                                Prueba de DNS proveedores

#ifconfig | grep ppp.-A2| grep inet| awk '{print $2}'| awk -F ":" '{print $2}'| xargs -n 1 dig@8.8.8$
cambiar ppp por eth para realizar pruebas en interfaces

----------------------------------------------------------------------------------------------------
                                Borrar cache RAM

#sync && echo 3 > /proc/sys/vm/drop_caches

----------------------------------------------------------------------------------------------------
                                hwinfo

#hwinfo --short --netcard network

--------------------------COMMON COMANDS----------------------------------------------------------

TUNELIZACIONES:
- Navegar a traves de un cliente:
ssh -N -D 8088 0.sancristobal.ciscnet.sequreisp.com

- Entrar a un equipo o dispositivo de un cliente:
sshuttle 192.168.1.0/24 -r 0.internetfacil.sequreisp.com

- Copiar un archivo a un cliente:
scp -v -P 22000 /home/miguelb/Actualizaciones/3.7.30.tar.gz.install.sh 4.viatec.sequreisp.com:/tmp

- Copiar un archivo de un cliente a mi home:
scp -v -P 22000 0.server1.sgc.sequreisp.com:/tmp/sequreisp_3.8.2-16-08-12-SEGTELCO.tar.gz .

----------------------------------------------------------------------------------------------------$

REINSTALL ULOGD:
*ULOGD es un paquete que permite sacar los logs de iptables a un archivo independiente y que sea lo $

apt-get remove --purge ulogd-pcap ulogd
apt-get update && apt-get install ulogd-pcap ulogd
/etc/init.d/ulogd restart
/etc/init.d/sequreisp restart

-------------------------------------------------------------------

APAGAR tso, gro y gso:
#ethtool -k [interfaz]: para ver
*tso: TCP segmentation offload (TSO)
*gso: generic segmentation offload (GSO)
*gro: generic receive offload (GRO)

ethtool -K eth1 tso off gso off gro off

-------------------------------------------------------------------

ACTIVAR MODO VERBOSE DAEMONS WISPRO
touch /opt/sequreisp/deploy/current/tmp/verbose

-------------------------------------------------------------------

BUSCAR CONTRATOS CON ARP:
Contract.all.collect{|a| puts "#{a.id} #{a.ip} - #{a.proxy_arp_provider}"};nil

-------------------------------------------------------------------

BORRAR CACHE DE RAM:
sync && echo 3 > /proc/sys/vm/drop_caches

-------------------------------------------------------------------

NMAP:
Sobre un puerto --> nmap -p 123 192.168.30.0/24
Escaneo rapido --> nmap -T4 -F 192.168.30.0/24
Todos los puertos --> nmap 192.168.30.0/24
Solo los abiertos --> nmap -O 192.168.30.0/24

-------------------------------------------------------------------

ERROR DE APT-GET UPDATE: 416 Requested Range Not Satisfiable
se soluciona con: rm -rf /var/lib/apt/lists/partial/*

-------------------------------------------------------------------

COMANDOS PARA APLICAR REGLAS TC SOBRE IFB0 y 1:
tc -force -b /opt/sequreisp/scripts/tc_ifb0

-------------------------------------------------------------------

PARA CHEQUEAR QUE LAS BROADCOM TENGAN EL MSI ACTIVO:
vim /etc/modprobe.d/sequreisp.conf

-------------------------------------------------------------------

FORZAR REINICO COMANDOS MÁGICOS:
echo 1 > /proc/sys/kernel/sysrq
echo b > /proc/sysrq-trigger

-------------------------------------------------------------------

COMPRIMIR Y DESCOMPRIMIR ARCHIVOS:
tar -czvf empaquetado.tar.gz /carpeta/a/empaquetar/
tar -xzvf archivo.tar.gz

-------------------------------------------------------------------

PROBAR DESCARGAS POR PROVEEDOR:
wget --bind-address=190.95.187.10 -O /dev/null http://wispro.co

-------------------------------------------------------------------

ACTUALIZAR A MANO:
scp -P 22000 -v /home/micus/ACTUALIZACIONES/3.7.31.tar.gz.install.sh 2.ifotoncorp.sequreisp.com:/tmp
cd /
bash /tmp/3.7.31.tar.gz.install.sh

-------------------------------------------------------------------

RECUPERAR LINK SIMBOLICO:
ln -s /opt/sequreisp/deploy/current/script/sequreisp /usr/local/bin/sequreisp

--------------------------------------------------------------------

BORRAR UN DISCO POR COMPLETO:
dd if=/dev/zero of=/dev/sdb count=10000

--------------------------------------------------------------------

REVISAR USO DE DISCOS:
df -h
cd /
du -sh *

--------------------------------------------------------------------

SCREEN:
screen -S mic
Ctrl+a d //para salir//
screen -list //para ver cuales hay creados
screen -x mic //para conectarse al screen mic//

--------------------------------------------------------------------

TOO MANY OPEN FILES:
ulimit -n 9000
vim /etc/sysctl.conf
//agregamos la linea//
fs.file-max = 2097152
service sequreisp restart
//para verificar://
sysctl -p
ulimit -Hn
ulimit -Sn

--------------------------------------------------------------------

APAGAR TSO-GSO-GRO:
ethtool -K tso off gso off gro off

--------------------------------------------------------------------

CHEQUEAR REGLAS DE TC:
cd /opt/sequreisp/scripts
egrep 10.0.0.18 tc_ifb1 //para ver el klass de la ip//
tc -s class show dev ifb1 | grep 4d0
watch -n 1 -d "tc -s class show dev ifb1 | grep 4d0"

--------------------------------------------------------------------

VER CONSUMO DE AB DE UNA IP:
iftop -i eth2 -F 192.168.0.2/255.255.255.255

--------------------------------------------------------------------

ARCHIVO QUE UTILIZA 3.7 PARA GRAFICAR:
/sys/class/net/eth2/statistics/tx_bytes

--------------------------------------------------------------------

AGREGAR UN SCRIPT AL CRON:
vim /etc/cron.d/sequreisp
*/5 * * * * root /usr/bin/logger -t [NOMBRE_SCRIPT] "$(path al script)" //para que lo ejecute cada 5$

--------------------------------------------------------------------

BUSCAR FALLOS DE PTABLES:
iptables_restore < /opt/sequreisp/scripts/tmp/iptables

--------------------------------------------------------------------

MODIFICAR ARCHIVOS:
sed -i "[X]" /etc/postfix/main.cf
//donde [X] puede ser: 3d=3ra linea, 1,3=de la 1 a la 3, 3$=de la 3 en adelante//
echo "sarasereando" >> /etc/postfix/main.cf

--------------------------------------------------------------------

COMPARAR DOS ARCHIVOS:
diff -wy [path1] [path2] < /opt/sequreisp/scripts/tmp/iptables

--------------------------------------------------------------------

INTERPRETACION DEL htop:
CPU&nbsp&nbsp&nbsp&nbsp&nbsp[|low-priority||||||normal||||||||||kernel|||||]
MEM&nbsp&nbsp&nbsp[|||||||used||||||||||||buffers|||||||||||cache|||||]

--------------------------------------------------------------------

#dmesg|ccze -A      para ver mensajes o errores de kernel hoy
#less /var/log/kern.log         para ver los mensajes historicos del kernel

-----------------------------------------------------------------------
#last reboot: te dice cuando se ha reiniciado, te sirve para ver los horarios de reinicio
              y buscas los logs en esas fechas y horas

----------------------------------------------------------------------

#last -n 50: te muestra los ultimos 50 registros de login al sistema
syslog    |
daemon.log| Otros archivos de log

----------------------------------------------------------------------

#watch -n 1 -d "cat /proc/interrupts |grep eth" para ver interrupciones

--------------------------------------------------------------------------

		Supercache comandos

tail  -F /var/log/sepia/access.log | grep --line-buffered YouTube | ccze -A

cat /usr/local/bin/satura

---------------------------------------------------------------------------

		Actualizar kernel
   
#apt-get install linux-image-3.13.0-93-generic linux-firmware linux-firmware-nonfree     (ACTUALIZAR KERNELLLL)
#update-grub

--------------------------------------------------------------------------------------
		Test.iso

cd /opt/sequreisp/deploy/shared/public/system
 dd if=/dev/zero of=test.iso bs=1M count=1 seek=4096
chown sequreisp.sequreisp test.iso                                         Se descarga con (IP LAn- Wispro)/system/test.iso

------------------------------------------------------------------------------------------

		Bibliografia iptables

http://www.linuxjournal.com/content/advanced-firewall-configurations-ipset

------------------------------------------------------------------------------------------

			Comandos varios
#tcpdump -i eth0 -nnnvvvel -s0 host {numero}| ccze -A
#ip a
#arping -I [interface] [host]
#ip route [get hostt]
#ssh 192.168.100.100 -p 22000
#ssh-copy-id root@192.168.100.100 -p 22000
#tail -F /tmp/sequreisp-update.log |ccze -A
#iptables -nvL INPUT
	opt/sequreisp/etc
#watch -n l -d iptables -nvL input
#sequreisp -t command	/// production
#touch optsequere deploy current tmp restart	
#ssh-add -l
#ip ro show table default
#dhclient eth0.303
#ip a|grep inet
#whereis
	/etc/udev/rules.d/70-persistent-net.rules   (CAMBIO DE NONBRES DE INTERFACES)
	hwinfo --short --netcard network  (DATOS DE INTERFACESS)
	 sync && echo 3 > /proc/sys/vm/drop_caches    (LIAMPAR CACHEEEee)
#iostat detect all system
#sshuttle -v **{192.168.88.0/24]** -r ****3.quadsys.quadsys.sequreisp.com***
#bmon                                        ver colas de qdisc
#iptraf
#iftop -i eth2 -n -f'(host 10.0.1.2)'
#ssh -N -D 8088 0.sancristobal.ciscnet.sequreisp.com                  SOCKS5
#watch -n1 -s "tc -s class show dev ifb1 |grep 1:9d0 -A4"
#tc class show dev ifb1|more
#scp -v -P 22000 /home/miguelb/Actualizaciones/3.7.30.tar.gz.install.sh 4.viatec.sequreisp.com:/tmp
#scp -v -P 22000 0.server1.sgc.sequreisp.com:/tmp/sequreisp_3.8.2-16-08-12-SEGTELCO.tar.gz .
#apt-get remove --purge ulogd-pcap ulogd
#apt-get update && apt-get install ulogd-pcap ulogd
	/etc/init.d/ulogd restart
	/etc/init.d/sequreisp restart

-------------------------------------------------------------------------------------------------------
			LOG's

Lo más recomendable es navegar hacia la carpeta /var/log y listar los archivos contenidos dentro de esa carpeta. 
Aparecerán todos los archivos de registro disponibles. Sus nombres son autoexplicativos.

#cd /var/log
#ls

Archivos de registro comunes (pueden variar según la distro):

    /var/log/message: registro de mensajes generales del sistema
    /var/log/auth.log: log de autenticación
    /var/log/kern.log: registro del kernel
    /var/log/cron.log: registro de crond
    /var/log/maillog: registro del servidor de mails
    /var/log/qmail/ : registro de Qmail
    /var/log/httpd/: registro de errores y accesos a Apache
    /var/log/lighttpd: registro de errores y accesos a Lighttpd
    /var/log/boot.log : registro de inicio del sistema
    /var/log/mysqld.log: registro de la base de datos MySQL
    /var/log/secure: log de autenticación
    /var/log/utmp or /var/log/wtmp : registro de logins

Conclusión, en /var/log se almacenan todos los registros del sistema. No obstante, algunas aplicaciones como httpd incluyen ahí 
dentro un subdirectorio en el que almacenan sus propios archivos de registro.

----------------------------------------------------------------------------------------------------------------

rm -rf /usr/local/bin/sequreisp;ln -s /opt/sequreisp/deploy/current/script/sequreisp /usr/local/bin/sequreisp -> recuperar link simbolico

------------------------------------------------------------------------------------------------------
PROBAR FILTRO PORNOGRAFIA

http_proxy=http://127.0.0.1:50000 wget http://x1.fap.to/images/thumb/46/119/1196745616.jpg


----------------------------------------------------------------------------------------------------------
Agregar usuario en Alpine Linux

adduser -D -u 1000 [nombre_de_usuario]
passwd [nombre_de_usuario]

-----------------------------------
Actualizar TLS (problema al actualizar)

apt-get install libgnutls26

--------------------------------------

u = Isp.last.users.last
u.confirmed_at = Time.zone.now
u.save

-------------------------------------------

#Reglas IPTransit
iptables -t nat -I POSTROUTING -o eth6 -s 201.254.221.0/24 -j ACCEPT
iptables -t nat -I POSTROUTING -o eth6 -s 200.63.158.58/30 -j ACCEPT
iptables -t nat -I POSTROUTING -o eth6 -j SNAT --to 201.254.221.2
iptables -t nat -I POSTROUTING -o eth6 -j SNAT --to 201.254.221.3
iptables -t nat -I POSTROUTING -o eth6 -j SNAT --to 201.254.221.4


--------------------------------------------
Repos de Wispro Classic funcionando para instalar libgnutls26

# File created by WisproPatch 

deb http://old-releases.ubuntu.com/ubuntu/ lucid main restricted universe multiverse 
deb http://old-releases.ubuntu.com/ubuntu/ lucid-updates main restricted universe multiverse 
deb http://old-releases.ubuntu.com/ubuntu/ lucid-security main restricted universe multiverse 

deb http://old-releases.ubuntu.com/ubuntu/ oneiric main restricted universe multiverse 
deb http://old-releases.ubuntu.com/ubuntu/ oneiric-updates main restricted universe multiverse 
deb http://old-releases.ubuntu.com/ubuntu/ oneiric-security main restricted universe multiverse 

deb http://archive.ubuntu.com/ubuntu/ precise main restricted universe multiverse 
deb http://archive.ubuntu.com/ubuntu/ precise-updates main restricted universe multiverse 
deb http://security.ubuntu.com/ubuntu/ precise-security main restricted universe multiverse 

deb http://ppa.launchpad.net/maco.m/ruby/ubuntu lucid main 
deb http://ppa.launchpad.net/freeradius/stable/ubuntu lucid main 




 -i .ssh/id_rsa_


----------------------------------------------------------



Buenas tardes, las versiones anteriores a 3.7.32 se encuentran descontinuadas y sin soporte debido a su antigüedad.
Las versiones soportadas son: 3.7.32, 3.7.33, 3.7.34, 3.7.35 y Wispro Cloud.

Deberá actualizar a dichas versiones para que lo podamos asistir.
Saludos cordiales.


